name: Karr CI

on:
    workflow_call:

permissions:
    contents: read

env:
    TURBO_TELEMETRY_DISABLED: 1
    # You can leverage Vercel Remote Caching with Turbo to speed up your builds
    # @link https://turborepo.org/docs/core-concepts/remote-caching#remote-caching-on-vercel-builds
    TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
    TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    HUSKY: 0

jobs:
    checks:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              name: Install pnpm
              with:
                  run_install: false

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install

            - name: Lint project
              run: pnpm run lint

            - name: Check types
              run: pnpm run check-types

            - name: Run tests
              run: pnpm run test

            - name: Debug specific files
              continue-on-error: true # This will make the step continue even if it fails
              run: |
                  echo "Checking ThemeSwitch.tsx:"
                  pnpm prettier --check apps/web/src/app/_components/ThemeSwitch.tsx --debug-print-doc || true

                  echo "\nChecking current format:"
                  cat apps/web/src/app/_components/ThemeSwitch.tsx || true

                  echo "\nChecking with write:"
                  pnpm prettier apps/web/src/app/_components/ThemeSwitch.tsx --write --loglevel debug || true

            - name: Debug Prettier plugins
              run: |
                  echo "Prettier config:"
                  NODE_DEBUG=prettier pnpm prettier --find-config-path apps/web/src/app/_components/ThemeSwitch.tsx || true
                  NODE_DEBUG=prettier pnpm prettier --config-precedence prefer-file --check apps/web/src/app/_components/ThemeSwitch.tsx || true

            - name: Check formatting
              run: pnpm run format:check
